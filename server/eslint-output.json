[{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\app.controller.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\app.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\app.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\app.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\auth.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\auth.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\auth.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is assigned a value but never used.","line":66,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":66,"endColumn":26}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@nestjs/common';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport * as bcrypt from 'bcrypt';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\nimport { RedisService } from 'src/redis/redis.service';\r\nimport { RegisterDto } from './dto/register.dto';\r\nimport { AuthResponseDto } from './dto/auth-response.dto';\r\nimport {\r\n  EmailAlreadyExistsException,\r\n  InvalidRefreshTokenException,\r\n} from './exceptions/auth.exceptions';\r\nimport {\r\n  ACCESS_TOKEN_EXPIRY,\r\n  REFRESH_TOKEN_EXPIRY,\r\n  REFRESH_TOKEN_EXPIRY_SECONDS,\r\n  REFRESH_TOKEN_KEY,\r\n  USER_TOKENS_PATTERN,\r\n} from './constants/auth.constants';\r\n\r\ninterface UserPayload {\r\n  id: number;\r\n  name: string;\r\n  email: string;\r\n}\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private jwtService: JwtService,\r\n    private configService: ConfigService,\r\n    private redisService: RedisService,\r\n  ) {}\r\n\r\n  async register(registerDto: RegisterDto): Promise<AuthResponseDto> {\r\n    const existingUser = await this.prisma.user.findUnique({\r\n      where: { email: registerDto.email },\r\n    });\r\n\r\n    if (existingUser) {\r\n      throw new EmailAlreadyExistsException();\r\n    }\r\n\r\n    const hashedPassword = await bcrypt.hash(registerDto.password, 10);\r\n\r\n    const user = await this.prisma.user.create({\r\n      data: {\r\n        name: registerDto.name,\r\n        email: registerDto.email,\r\n        password: hashedPassword,\r\n      },\r\n    });\r\n\r\n    return this.generateTokens(user);\r\n  }\r\n\r\n  async validateUser(\r\n    email: string,\r\n    password: string,\r\n  ): Promise<UserPayload | null> {\r\n    const user = await this.prisma.user.findUnique({ where: { email } });\r\n\r\n    if (user && (await bcrypt.compare(password, user.password))) {\r\n      const { password: _, ...result } = user;\r\n      return result;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  async login(user: UserPayload): Promise<AuthResponseDto> {\r\n    return this.generateTokens(user);\r\n  }\r\n\r\n  async refreshTokens(\r\n    userId: number,\r\n    tokenId: string,\r\n    refreshToken: string,\r\n  ): Promise<AuthResponseDto> {\r\n    // Verify token exists in Redis\r\n    const storedToken = await this.redisService.get(\r\n      REFRESH_TOKEN_KEY(userId, tokenId),\r\n    );\r\n\r\n    if (!storedToken || storedToken !== refreshToken) {\r\n      throw new InvalidRefreshTokenException();\r\n    }\r\n\r\n    // Delete old refresh token\r\n    await this.redisService.del(REFRESH_TOKEN_KEY(userId, tokenId));\r\n\r\n    // Get user from database\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { id: true, name: true, email: true },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new InvalidRefreshTokenException();\r\n    }\r\n\r\n    return this.generateTokens(user);\r\n  }\r\n\r\n  async logout(userId: number, tokenId: string): Promise<void> {\r\n    await this.redisService.del(REFRESH_TOKEN_KEY(userId, tokenId));\r\n  }\r\n\r\n  async logoutAll(userId: number): Promise<void> {\r\n    await this.redisService.delByPattern(USER_TOKENS_PATTERN(userId));\r\n  }\r\n\r\n  private async generateTokens(user: UserPayload): Promise<AuthResponseDto> {\r\n    const tokenId = uuidv4();\r\n    const payload = { sub: user.id, email: user.email };\r\n\r\n    const accessToken = this.jwtService.sign(payload, {\r\n      secret: this.configService.get<string>('JWT_ACCESS_SECRET'),\r\n      expiresIn: ACCESS_TOKEN_EXPIRY,\r\n    });\r\n\r\n    const refreshToken = this.jwtService.sign(\r\n      { ...payload, jti: tokenId },\r\n      {\r\n        secret: this.configService.get<string>('JWT_REFRESH_SECRET'),\r\n        expiresIn: REFRESH_TOKEN_EXPIRY,\r\n      },\r\n    );\r\n\r\n    // Store refresh token in Redis with TTL\r\n    await this.redisService.set(\r\n      REFRESH_TOKEN_KEY(user.id, tokenId),\r\n      refreshToken,\r\n      REFRESH_TOKEN_EXPIRY_SECONDS,\r\n    );\r\n\r\n    return {\r\n      accessToken,\r\n      refreshToken,\r\n      user: {\r\n        id: user.id,\r\n        name: user.name,\r\n        email: user.email,\r\n      },\r\n    };\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\constants\\auth.constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\decorators\\current-user.decorator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\decorators\\public.decorator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\dto\\auth-response.dto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\dto\\login.dto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\dto\\refresh-token.dto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\dto\\register.dto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\exceptions\\auth.exceptions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\guards\\jwt-auth.guard.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\guards\\jwt-refresh.guard.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\guards\\local-auth.guard.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\strategies\\jwt-refresh.strategy.ts","messages":[{"ruleId":"@typescript-eslint/require-await","severity":2,"message":"Async method 'validate' has no 'await' expression.","line":25,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":25,"endColumn":17,"suggestions":[{"messageId":"removeAsync","fix":{"range":[743,749],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":29,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":29,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .refreshToken on an `any` value.","line":29,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":29,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":30,"column":26,"nodeType":"Property","messageId":"anyAssignment","endLine":30,"endColumn":38}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ExtractJwt, Strategy } from 'passport-jwt';\r\nimport { PassportStrategy } from '@nestjs/passport';\r\nimport { Injectable } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { Request } from 'express';\r\n\r\n@Injectable()\r\nexport class JwtRefreshStrategy extends PassportStrategy(\r\n  Strategy,\r\n  'jwt-refresh',\r\n) {\r\n  constructor(configService: ConfigService) {\r\n    const secret = configService.get<string>('JWT_REFRESH_SECRET');\r\n    if (!secret) {\r\n      throw new Error('JWT_REFRESH_SECRET is not defined');\r\n    }\r\n    super({\r\n      jwtFromRequest: ExtractJwt.fromBodyField('refreshToken'),\r\n      ignoreExpiration: false,\r\n      secretOrKey: secret,\r\n      passReqToCallback: true,\r\n    });\r\n  }\r\n\r\n  async validate(\r\n    req: Request,\r\n    payload: { sub: number; email: string; jti: string },\r\n  ) {\r\n    const refreshToken = req.body.refreshToken;\r\n    return { ...payload, refreshToken };\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\strategies\\jwt.strategy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\auth\\strategies\\local.strategy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\main.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\prisma\\prisma.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\prisma\\prisma.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\redis\\redis.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Shootup\\hello-world-nest\\hello-world\\src\\redis\\redis.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
